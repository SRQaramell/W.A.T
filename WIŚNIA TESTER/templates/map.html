<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa anten – z bazą (ALLY/ENEMY)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .toolbar, .basebar {
      position: absolute;
      display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
      background: #fff; padding: 6px 10px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
      z-index: 999;
    }
    .toolbar { bottom: 12px; right: 12px; }
    .basebar { bottom: 12px; left: 12px; }

    .toolbar select, .toolbar input, .toolbar button,
    .basebar select, .basebar button { font: 600 13px system-ui; border-radius: 6px; padding: 4px 6px; }
    .btn { border: none; cursor: pointer; }
    .btn.active { background: #cde9ff; }
    .cursor-crosshair { cursor: crosshair !important }

    /* marker z napisem 2G/3G/4G/5G (kolor wg afiliacji anteny) */
    .badge {
      transform: translate(-50%, -100%);
      display: inline-flex; align-items: center; justify-content: center;
      width: 34px; height: 34px; border-radius: 50%;
      border: 2px solid rgba(0,0,0,.25);
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
      font: 800 12px/1 system-ui, sans-serif; color: #fff;
      text-shadow: 0 1px 1px rgba(0,0,0,.35);
      user-select: none;
    }
    .aff-ally    { background: #16a34a; }  /* zielony */
    .aff-enemy   { background: #dc2626; }  /* czerwony */
    .aff-neutral { background: #2563eb; }  /* niebieski */
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- TOOLBAR anten: ogólna/kierunkowa, wiązka, afiliacja, rola, kategoria, + -->
  <div class="toolbar">
    <select id="selKind">
      <option value="ogolna" selected>Ogólna (360°)</option>
      <option value="kierunkowa">Kierunkowa (sektor)</option>
    </select>

    <label style="display:flex;align-items:center;gap:4px;">
      Wiązka°
      <input id="beam" type="number" min="10" max="180" step="5" value="60" style="width:68px;">
    </label>

    <select id="selAff">
      <option value="ally" selected>Sojusznicza</option>
      <option value="enemy">Wroga</option>
      <option value="neutral">Neutralna</option>
    </select>
    <select id="selRole">
      <option value="transmission" selected>Transmisyjna (cień zielony)</option>
      <option value="jamming">Zakłócająca (cień czerwony)</option>
    </select>
    <select id="selCat">
      <option value="2">2G</option>
      <option value="3">3G</option>
      <option value="4">4G</option>
      <option value="5" selected>5G</option>
    </select>

    <button class="btn" id="btnAdd">+</button>
  </div>

  <!-- BAZA: wybór typu i przycisk postawienia -->
  <div class="basebar">
    <select id="baseType">
      <option value="ally" selected>Baza Sojusznicza</option>
      <option value="enemy">Baza Wroga</option>
    </select>
    <button class="btn" id="btnPlaceBase" title="Postaw bazę">Baza</button>
  </div>

  <script>
    // === MAPA ===
    const map = L.map('map', { center: [51.1079, 17.0385], zoom: 13 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, minZoom: 2, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const antennasLayer = L.layerGroup().addTo(map);
    const basesLayer = L.layerGroup().addTo(map);

    // === IKONY ANTEN (środek z napisem 2G/3G/4G/5G) ===
    function markerIcon(category, affiliation) {
      const classes = ['badge'];
      if (affiliation === 'ally') classes.push('aff-ally');
      else if (affiliation === 'enemy') classes.push('aff-enemy');
      else classes.push('aff-neutral');

      return L.divIcon({
        className: classes.join(' '),
        html: `<span>${Number(category)}G</span>`,
        iconSize: [34,34], iconAnchor:[17,34], popupAnchor:[0,-34]
      });
    }

    // === STYLE POKRYCIA ANTEN: role → fill (bez obwódek) ===
    function coverageStyle(role) {
      const fill = role === 'jamming' ? '#dc2626' : '#16a34a'; // czerwień dla zakłócania, zieleń dla transmisji
      return { fillColor: fill, fillOpacity: 0.15, stroke: false };
    }

    // === GEOMETRIA (kierunkowe) ===
    function computeBearingDeg(a,b){
      const φ1=a.lat*Math.PI/180, φ2=b.lat*Math.PI/180, Δλ=(b.lng-a.lng)*Math.PI/180;
      const y=Math.sin(Δλ)*Math.cos(φ2);
      const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      let θ=Math.atan2(y,x)*180/Math.PI; return (θ+360)%360;
    }
    function destPoint(origin, distanceMeters, bearingDeg){
      const R=6371000, φ1=origin.lat*Math.PI/180, λ1=origin.lng*Math.PI/180, θ=bearingDeg*Math.PI/180, δ=distanceMeters/R;
      const sinφ1=Math.sin(φ1), cosφ1=Math.cos(φ1), sinδ=Math.sin(δ), cosδ=Math.cos(δ);
      const sinφ2=sinφ1*cosδ+cosφ1*sinδ*Math.cos(θ); const φ2=Math.asin(sinφ2);
      const y=Math.sin(θ)*sinδ*cosφ1, x=cosδ-sinφ1*sinφ2; const λ2=λ1+Math.atan2(y,x);
      return L.latLng(φ2*180/Math.PI, ((λ2*180/Math.PI+540)%360)-180);
    }
    function sectorPolygon(centerLatLng, radiusMeters, bearingDeg, widthDeg, steps=64, style={}){
      const pts=[centerLatLng], start=(bearingDeg-widthDeg/2), end=(bearingDeg+widthDeg/2), d=(end-start)/steps;
      for(let i=0;i<=steps;i++){ const ang=start+d*i; pts.push(destPoint(centerLatLng, radiusMeters, ang)); }
      pts.push(centerLatLng); return L.polygon(pts, style);
    }

    // === API (Twoje endpointy z app.py) ===
    async function apiGetAntennas(){ const r=await fetch('/api/antennas'); return r.json(); }
    async function apiCreateAntenna(payload){
      const r=await fetch('/api/antennas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!r.ok) throw new Error('POST /api/antennas failed'); return r.json();
    }
    async function deleteAntenna(id){ const r=await fetch('/api/antennas/'+id,{method:'DELETE'}); return r.status===204; }

    // === RYSOWANIE ANTEN ===
    function popupHtml(a) {
      return `
        <b>${a.category}G</b> — ${a.antenna_type}<br/>
        Rola: ${a.role}, Afiliacja: ${a.affiliation}<br/>
        Lat: ${a.lat.toFixed(5)}, Lng: ${a.lng.toFixed(5)}<br/>
        Wysokość: ${a.height != null ? a.height.toFixed(1) + ' m n.p.m.' : '—'}<br/>
        Promień: ${a.radius} m
        <div style="margin-top:6px;"><button data-del="${a.id}">Usuń</button></div>
      `;
    }
    function renderAntenna(a){
      const marker = L.marker([a.lat, a.lng], { icon: markerIcon(a.category, a.affiliation) }).addTo(antennasLayer);
      const style = coverageStyle(a.role);

      let shape;
      if (a.antenna_type === 'kierunkowa' && typeof a.bearing_deg === 'number') {
        shape = sectorPolygon([a.lat, a.lng], a.radius, a.bearing_deg, a.beam_width_deg || 60, 64, style)
          .addTo(antennasLayer);
      } else {
        shape = L.circle([a.lat, a.lng], { radius: a.radius, ...style }).addTo(antennasLayer);
      }

      marker.bindPopup(popupHtml(a));
      marker.on('popupopen', (e)=>{
        const btn = e.popup.getElement().querySelector('button[data-del]');
        if(btn) btn.onclick = async ()=>{
          const ok = await deleteAntenna(a.id);
          if(ok){ antennasLayer.removeLayer(marker); antennasLayer.removeLayer(shape); }
        };
      });
    }

    // === Wczytaj istniejące anteny ===
    (async function(){
      const data = await apiGetAntennas();
      data.forEach(renderAntenna);
    })();

    // === TRYB DODAWANIA ANTEN ===
    let kind = 'ogolna', beam = 60, aff = 'ally', role = 'transmission', cat = 5;
    let addMode = false, anchor = null, anchorMarker = null;

    document.getElementById('selKind').onchange = e => kind = e.target.value;
    document.getElementById('beam').onchange = e => beam = Math.max(10, Math.min(180, Number(e.target.value||60)));
    document.getElementById('selAff').onchange = e => aff = e.target.value;
    document.getElementById('selRole').onchange = e => role = e.target.value;
    document.getElementById('selCat').onchange = e => cat = Number(e.target.value);

    const btnAdd = document.getElementById('btnAdd');
    btnAdd.onclick = () => {
      addMode = !addMode;
      clearAnchor();
      btnAdd.classList.toggle('active', addMode);
      map.getContainer().classList.toggle('cursor-crosshair', addMode);
    };

    function clearAnchor(){
      anchor=null; if(anchorMarker){ antennasLayer.removeLayer(anchorMarker); anchorMarker=null; }
    }

    map.on('click', async (e)=>{
      if(!addMode) return;

      if (kind === 'ogolna') {
        await placeOne(e.latlng.lat, e.latlng.lng, null);
      } else {
        if (!anchor) {
          anchor = e.latlng;
          anchorMarker = L.circleMarker(anchor,{radius:6,weight:2,color:'#111',fillColor:'#0af',fillOpacity:.85})
            .bindTooltip('Punkt anteny ustawiony — kliknij kierunek',{permanent:true,direction:'top'})
            .addTo(antennasLayer);
        } else {
          const bearing = computeBearingDeg(anchor, e.latlng);
          await placeOne(anchor.lat, anchor.lng, bearing);
          clearAnchor();
        }
      }
    });

    async function placeOne(lat, lng, bearing){
      const payload = {
        lat, lng,
        radius: 300,
        category: cat,
        affiliation: aff,
        role: role,
        antenna_type: kind
      };
      if (kind === 'kierunkowa') {
        payload.bearing_deg = bearing;
        payload.beam_width_deg = beam;
      }
      const saved = await apiCreateAntenna(payload);
      renderAntenna(saved);
    }

    // =================== BAZY (ALLY / ENEMY) ===================

    // Ścieżki do ikon (umieść pliki w /static/ICONS/)
    const HQ_ALLY_URL  = "static/ICONS/HQ_ALLY.png";
    const HQ_ENEMY_URL = "static/ICONS/HQ_ENEMY.png";

    const hqIconAlly = L.icon({
      iconUrl: HQ_ALLY_URL,
      iconSize: [44,44],
      iconAnchor: [22,44],
      popupAnchor: [0,-44]
    });
    const hqIconEnemy = L.icon({
      iconUrl: HQ_ENEMY_URL,
      iconSize: [44,44],
      iconAnchor: [22,44],
      popupAnchor: [0,-44]
    });

    function baseFillColor(type) {
      // tylko cień: zielony dla sojuszniczej, czerwony dla wrogiej
      return type === 'ally' ? '#16a34a' : '#dc2626';
    }

    let baseTypeSel = document.getElementById('baseType');
    let btnPlaceBase = document.getElementById('btnPlaceBase');
    let basePlaceMode = false;

    btnPlaceBase.onclick = () => {
      basePlaceMode = !basePlaceMode;
      btnPlaceBase.classList.toggle('active', basePlaceMode);
      map.getContainer().classList.toggle('cursor-crosshair', basePlaceMode);
      if (basePlaceMode) {
        // wyłącz dodawanie anten, jeśli było aktywne
        if (addMode) btnAdd.click();
        map.on('click', placeBaseOnce);
      } else {
        map.off('click', placeBaseOnce);
      }
    };

    function placeBaseOnce(e) {
      const t = baseTypeSel.value; // ally | enemy
      const icon = (t === 'ally') ? hqIconAlly : hqIconEnemy;
      const fill = baseFillColor(t);

      const m = L.marker(e.latlng, { icon }).addTo(basesLayer)
        .bindPopup(`<b>HQ ${t.toUpperCase()}</b><br>Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}<br>Promień: 300 m`)
        .openPopup();

      const circle = L.circle(e.latlng, { radius: 300, fillColor: fill, fillOpacity: 0.15, stroke: false })
        .addTo(basesLayer);

      // wyłącz tryb stawiania bazy po jednym kliknięciu
      basePlaceMode = false;
      btnPlaceBase.classList.remove('active');
      map.getContainer().classList.remove('cursor-crosshair');
      map.off('click', placeBaseOnce);

      // proste usuwanie po kliknięciu PPM (opcjonalnie)
      m.on('contextmenu', () => { basesLayer.removeLayer(m); basesLayer.removeLayer(circle); });
    }
  </script>
</body>
</html>
